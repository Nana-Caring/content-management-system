@page
@model CMS.Web.Pages.Users.IndexModel
@{
    ViewData["Title"] = "Users Management";
}

@section Scripts {
}

<!-- Hidden form for anti-forgery token -->
<form style="display: none;">
    @Html.AntiForgeryToken()
</form>

<style>
    /* Original table and page styles */
    .professional-table {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 0.75rem;
        line-height: 1.4;
    }
    
    .professional-table th {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        padding: 0.8rem 0.6rem;
        border-bottom: 2px solid #dee2e6;
        background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        color: white;
    }
    
    .professional-table td {
        font-size: 0.75rem;
        padding: 0.6rem 0.5rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f3f4;
        color: #2c3e50;
        line-height: 1.3;
    }
    
    .professional-table tbody tr {
        transition: none;
    }
    
    /* Color utilities */
    .text-orange {
        color: #fd7e14 !important;
    }
    
    .user-card {
        border: none;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .user-card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    
    .filter-card {
        border: none;
        box-shadow: 0 1px 8px rgba(0,0,0,0.06);
        border-radius: 10px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    .stats-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .modern-btn {
        border-radius: 8px;
        padding: 0.5rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
    }
    
    .modern-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .role-badge {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .id-badge {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        color: #5e35b1;
        font-weight: 700;
        font-size: 0.75rem;
        padding: 0.35rem 0.7rem;
        border-radius: 10px;
        font-family: 'Courier New', Consolas, monospace;
        letter-spacing: 0.5px;
    }
    
    .sort-link {
        color: #ffffff !important;
        text-decoration: none !important;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: inherit;
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .sort-link:hover {
        color: #e3f2fd !important;
        transform: translateY(-1px);
    }
    
    .sort-icon {
        font-size: 0.7rem;
        opacity: 0.8;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    
    .empty-state {
        padding: 3rem 2rem;
        text-align: center;
        color: #6c757d;
    }
    
    .empty-state i {
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    /* Action Button Styles */
    .btn-group {
        display: flex;
        gap: 3px;
        justify-content: center;
    }
    
    .btn-group .btn {
        padding: 0.35rem 0.7rem;
        margin: 0;
        font-size: 0.75rem;
        border-radius: 6px;
        min-width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        border-width: 1.5px;
    }
    
    .btn-group .btn i {
        font-size: 0.8rem;
    }
    
    .modern-btn {
        transition: all 0.2s ease;
        font-weight: 500;
    }
    
    .modern-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    
    .btn-outline-warning:hover {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
    }
    
    .btn-outline-danger:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    /* Actions column minimum width */
    .actions-column {
        min-width: 160px;
        width: 160px;
    }
    
    /* Scrollable Table Styles */
    .scrollable-table-container {
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        background: white;
        position: relative;
    }
    
    .scrollable-table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .scrollable-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .scrollable-table-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
    }
    
    .scrollable-table-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
    
    /* Firefox scrollbar */
    .scrollable-table-container {
        scrollbar-width: thin;
        scrollbar-color: #667eea #f1f1f1;
    }
    
    /* Sticky header for scrollable table */
    .scrollable-table-container .professional-table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Smooth scrolling */
    .scrollable-table-container {
        scroll-behavior: smooth;
    }
    
    /* Remove row hover effect with scroll */
    
    /* Table info overlay */
    .table-info-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        color: #6c757d;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 5;
    }
    
    /* Scroll to top button */
    .scroll-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .scroll-to-top.visible {
        opacity: 1;
        visibility: visible;
    }
    
    .scroll-to-top:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    /* Smaller font sizes for various elements */
    .fw-bold {
        font-size: 0.75rem !important;
    }
    
    .text-muted {
        font-size: 0.65rem !important;
    }
    
    .badge {
        font-size: 0.65rem !important;
        padding: 0.25rem 0.5rem !important;
    }
    
    .id-badge {
        font-size: 0.7rem !important;
    }
    
    /* Responsive styles for action buttons */
    @@media (max-width: 768px) {
        .btn-group {
            gap: 1px;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.4rem;
            min-width: 28px;
            height: 28px;
            font-size: 0.7rem;
        }
        
        .btn-group .btn i {
            font-size: 0.7rem;
        }
        
        .actions-column {
            min-width: 120px;
            width: 120px;
        }
    }
    
    /* Ensure buttons are always visible */
    .btn-group .btn {
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Remove button hover effects on row hover */
        font-weight: 600;
        z-index: 2;
    }
</style>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 mb-2 fw-bold">Users Management</h1>
            <p class="mb-0 opacity-75">Manage and monitor all user accounts in the system</p>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <span class="stats-badge badge">
                Total: @Model.TotalCount Users
                @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter) || !string.IsNullOrEmpty(Model.RelationFilter) || Model.CreatedFromDate.HasValue || Model.CreatedToDate.HasValue)
                {
                    <span class="text-light opacity-75">| Filtered</span>
                }
            </span>
            <button class="btn btn-light modern-btn" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <i class="fas fa-sliders-h me-2"></i>Advanced Filters
            </button>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-start">
            <div class="me-3">
                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
            </div>
            <div class="flex-grow-1">
                <h6 class="alert-heading mb-2">
                    <i class="fas fa-cloud-exclamation-alt me-2"></i>Backend Service Status
                </h6>
                <p class="mb-3">@Model.ErrorMessage</p>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-warning btn-sm" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt me-1"></i>Retry Now
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="checkServiceStatus()">
                        <i class="fas fa-heartbeat me-1"></i>Check Service Status
                    </button>
                </div>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Filter Panel -->
<div class="collapse @((!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter) || !string.IsNullOrEmpty(Model.RelationFilter) || Model.CreatedFromDate.HasValue || Model.CreatedToDate.HasValue) ? "show" : "")" id="filterPanel">
    <div class="filter-card card mb-4">
        <div class="card-header bg-transparent border-0 pb-0">
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-sliders-h text-white" style="font-size: 0.875rem;"></i>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold">Advanced Filters</h6>
                    <small class="text-muted">Refine your search with multiple criteria</small>
                </div>
            </div>
        </div>
        <div class="card-body pt-3">
            <form method="get">
                <div class="row g-3">
                    <!-- Search -->
                    <div class="col-md-4">
                        <label for="search" class="form-label fw-semibold">
                            <i class="fas fa-search me-1 text-primary"></i>Search
                        </label>
                        <input type="text" class="form-control border-0 bg-light" 
                               id="search" name="search" value="@Model.SearchTerm" 
                               placeholder="Name, email, ID number...">
                    </div>
                    
                    <!-- Role Filter -->
                    <div class="col-md-2">
                        <label for="roleFilter" class="form-label fw-semibold">
                            <i class="fas fa-user-tag me-1 text-success"></i>Role
                        </label>
                        <select class="form-select border-0 bg-light" id="roleFilter" name="roleFilter">
                            <option value="">All Roles</option>
                            @foreach (var role in Model.AvailableRoles)
                            {
                                <option value="@role" selected="@(Model.RoleFilter == role)">@role</option>
                            }
                        </select>
                    </div>
                    
                    <!-- Relation Filter -->
                    <div class="col-md-2">
                        <label for="relationFilter" class="form-label fw-semibold">
                            <i class="fas fa-link me-1 text-info"></i>Relation
                        </label>
                        <select class="form-select border-0 bg-light" id="relationFilter" name="relationFilter">
                            <option value="">All Relations</option>
                            @foreach (var relation in Model.AvailableRelations)
                            {
                                <option value="@relation" selected="@(Model.RelationFilter == relation)">@relation</option>
                            }
                        </select>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="col-md-2">
                        <label for="createdFrom" class="form-label fw-semibold">
                            <i class="fas fa-calendar-alt me-1 text-warning"></i>From Date
                        </label>
                        <input type="date" class="form-control border-0 bg-light" 
                               id="createdFrom" name="createdFrom" 
                               value="@(Model.CreatedFromDate?.ToString("yyyy-MM-dd"))">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="createdTo" class="form-label fw-semibold">
                            <i class="fas fa-calendar-check me-1 text-warning"></i>To Date
                        </label>
                        <input type="date" class="form-control border-0 bg-light" 
                               id="createdTo" name="createdTo" 
                               value="@(Model.CreatedToDate?.ToString("yyyy-MM-dd"))">
                    </div>
                </div>
                
                <!-- Hidden sort parameters -->
                <input type="hidden" name="sortBy" value="@Model.SortBy">
                <input type="hidden" name="sortDirection" value="@Model.SortDirection">
                
                <!-- Filter Actions -->
                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary modern-btn">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        <a href="?" class="btn btn-outline-secondary modern-btn">
                            <i class="fas fa-times me-2"></i>Clear All
                        </a>
                        @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter) || !string.IsNullOrEmpty(Model.RelationFilter) || Model.CreatedFromDate.HasValue || Model.CreatedToDate.HasValue)
                        {
                            <span class="badge bg-success align-self-center">
                                <i class="fas fa-filter me-1"></i>Filters Active
                            </span>
                        }
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="user-card card">
    <div class="card-body p-0">
        <!-- Table Info Overlay -->
        <div class="table-info-overlay">
            <i class="fas fa-users me-1"></i>
            <span>@Model.TotalCount users total</span>
            @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter) || !string.IsNullOrEmpty(Model.RelationFilter) || Model.CreatedFromDate.HasValue || Model.CreatedToDate.HasValue)
            {
                <span class="text-primary">| Filtered</span>
            }
        </div>
        
        <!-- Scrollable Table Container -->
        <div class="scrollable-table-container" id="users-table-container">
            <table class="professional-table table align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("Id")" class="sort-link">
                                <span>ID</span>
                                <i class="@Model.GetSortIcon("Id") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("FullName")" class="sort-link">
                                <span>Full Name</span>
                                <i class="@Model.GetSortIcon("FullName") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("Role")" class="sort-link">
                                <span>Role</span>
                                <i class="@Model.GetSortIcon("Role") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("Email")" class="sort-link">
                                <span>Email</span>
                                <i class="@Model.GetSortIcon("Email") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("Relation")" class="sort-link">
                                <span>Relation</span>
                                <i class="@Model.GetSortIcon("Relation") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("PhoneNumber")" class="sort-link">
                                <span>Phone</span>
                                <i class="@Model.GetSortIcon("PhoneNumber") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("CreatedAt")" class="sort-link">
                                <span>Created</span>
                                <i class="@Model.GetSortIcon("CreatedAt") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0">
                            <a href="@Model.GetSortUrl("UpdatedAt")" class="sort-link">
                                <span>Updated</span>
                                <i class="@Model.GetSortIcon("UpdatedAt") sort-icon"></i>
                            </a>
                        </th>
                        <th class="border-0 text-center">Status</th>
                        <th class="border-0 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Users != null && Model.Users.Any())
                {
                    foreach (var user in Model.Users)
                    {
                        <tr data-user-id="@user.Id">
                            <td>
                                <span class="id-badge">
                                    #@user.Id
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px; font-size: 0.9rem; color: white; font-weight: 600;">
                                        @(user.FirstName.FirstOrDefault())@(user.Surname.FirstOrDefault())
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark" style="font-size: 0.95rem;">@user.FullName</div>
                                        @if (!string.IsNullOrEmpty(user.FirstName) && !string.IsNullOrEmpty(user.Surname))
                                        {
                                            <small class="text-muted" style="font-size: 0.8rem;">@user.FirstName @(!string.IsNullOrEmpty(user.MiddleName) ? user.MiddleName + " " : "")@user.Surname</small>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="role-badge badge @(user.Role.ToLower() switch {
                                    "admin" => "bg-gradient bg-danger",
                                    "user" => "bg-gradient bg-primary", 
                                    "dependent" => "bg-gradient bg-info",
                                    _ => "bg-gradient bg-secondary"
                                })">
                                    @user.Role
                                </span>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(user.Email))
                                {
                                    <div class="d-flex align-items-center">
                                        <span class="text-dark fw-medium" style="font-size: 0.85rem;">
                                            <i class="fas fa-envelope me-2 text-muted" style="font-size: 0.75rem;"></i>
                                            <a href="mailto:@user.Email" class="text-decoration-none text-dark">@user.Email</a>
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted" style="font-size: 0.85rem;">
                                        <i class="fas fa-minus" style="font-size: 0.7rem;"></i> No email
                                    </span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(user.Relation))
                                {
                                    <span class="badge bg-light text-dark border" style="font-size: 0.75rem; font-weight: 500;">@user.Relation</span>
                                }
                                else
                                {
                                    <span class="text-muted" style="font-size: 0.85rem;">—</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(user.PhoneNumber))
                                {
                                    <div class="text-dark fw-medium" style="font-size: 0.9rem;">
                                        <i class="fas fa-phone me-1 text-muted" style="font-size: 0.8rem;"></i>
                                        <a href="tel:@user.PhoneNumber" class="text-decoration-none">@user.PhoneNumber</a>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted" style="font-size: 0.85rem;">—</span>
                                }
                            </td>
                            <td>
                                <div class="text-dark fw-medium" style="font-size: 0.85rem;">@user.CreatedAt.ToString("MMM dd, yyyy")</div>
                                <small class="text-muted" style="font-size: 0.75rem;">@user.CreatedAt.ToString("HH:mm")</small>
                            </td>
                            <td>
                                <div class="text-dark fw-medium" style="font-size: 0.85rem;">@user.UpdatedAt.ToString("MMM dd, yyyy")</div>
                                <small class="text-muted" style="font-size: 0.75rem;">@user.UpdatedAt.ToString("HH:mm")</small>
                            </td>
                            <td class="text-center">
                                @if (user.IsBlocked)
                                {
                                    <span class="badge bg-danger">
                                        <i class="fas fa-ban me-1"></i>Blocked
                                    </span>
                                    @if (!string.IsNullOrEmpty(user.BlockReason))
                                    {
                                        <div>
                                            <small class="text-muted" style="font-size: 0.7rem;" title="@user.BlockReason">
                                                @(user.BlockReason.Length > 20 ? user.BlockReason.Substring(0, 20) + "..." : user.BlockReason)
                                            </small>
                                        </div>
                                    }
                                }
                                else if (!string.IsNullOrEmpty(user.Status) && user.Status.ToLower() == "suspended")
                                {
                                    <span class="badge bg-warning">
                                        <i class="fas fa-pause me-1"></i>Suspended
                                    </span>
                                    @if (!string.IsNullOrEmpty(user.BlockReason))
                                    {
                                        <div>
                                            <small class="text-muted" style="font-size: 0.7rem;" title="@user.BlockReason">
                                                @(user.BlockReason.Length > 20 ? user.BlockReason.Substring(0, 20) + "..." : user.BlockReason)
                                            </small>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>Active
                                    </span>
                                }
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="User Actions">
                                        <i class="fas fa-cog"></i> Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        @if (user.Status?.ToLower() == "active")
                                        {
                                            <li><a class="dropdown-item" href="#" onclick="showBlockModal(@user.Id, '@user.FullName')"><i class="fas fa-ban me-2 text-warning"></i>Block User</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="showSuspendModal(@user.Id, '@user.FullName')"><i class="fas fa-clock me-2 text-orange"></i>Suspend User</a></li>
                                        }
                                        else if (user.IsBlocked)
                                        {
                                            <li><a class="dropdown-item" href="#" onclick="showUnblockModal(@user.Id, '@user.FullName')"><i class="fas fa-check me-2 text-success"></i>Unblock User</a></li>
                                        }
                                        else if (user.Status?.ToLower() == "suspended")
                                        {
                                            <li><a class="dropdown-item" href="#" onclick="unsuspendUser(@user.Id, '@user.FullName')"><i class="fas fa-unlock me-2 text-info"></i>Unsuspend User</a></li>
                                        }
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteModal(@user.Id, '@user.FullName')"><i class="fas fa-trash me-2"></i>Delete User</a></li>
                                    </ul>
                                </div>
                            </td>
                            <!-- Actions column removed; actions will appear in popup/modal -->
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="10" class="border-0">
                            <div class="empty-state">
                                <i class="fas fa-users fa-4x"></i>
                                @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter) || !string.IsNullOrEmpty(Model.RelationFilter) || Model.CreatedFromDate.HasValue || Model.CreatedToDate.HasValue)
                                {
                                    <h5 class="mt-3 mb-2">No users found</h5>
                                    <p class="mb-3">No users match your current filter criteria.</p>
                                    <a href="?" class="btn btn-outline-primary modern-btn">
                                        <i class="fas fa-times me-2"></i>Clear Filters
                                    </a>
                                }
                                else
                                {
                                    <h5 class="mt-3 mb-2">No users available</h5>
                                    <p class="mb-0">There are currently no users in the system.</p>
                                }
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Total users information -->
@if (Model.Users?.Any() == true)
{
    <div class="mt-4">
        <small class="text-muted">
            Showing @Model.Users.Count of @Model.TotalCount total users
        </small>
    </div>
}

<!-- Scroll to Top Button -->
<button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()" title="Scroll to top">
    <i class="fas fa-arrow-up"></i>
</button>

<!-- Block Confirmation Modal -->
<div class="modal fade" id="blockModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark border-0">
                <div class="d-flex align-items-center">
                    <div class="bg-dark bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-ban text-dark"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0 fw-bold">Block User</h5>
                        <small class="opacity-75">Restrict user access</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-3">
                    <div class="bg-warning bg-opacity-10 rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-lock text-warning fa-2x"></i>
                    </div>
                    <h6 class="fw-bold mb-2">Block User Account</h6>
                    <p class="text-muted mb-3">
                        Are you sure you want to block <strong id="blockUserName" class="text-dark"></strong>?
                    </p>
                </div>
                <div class="mb-3">
                    <label for="blockReason" class="form-label fw-medium">Reason for blocking:</label>
                    <textarea class="form-control" id="blockReason" rows="3" placeholder="Enter the reason for blocking this user..."></textarea>
                </div>
                <div class="alert alert-info border-0 bg-info bg-opacity-10" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <small class="mb-0">
                            The user will be immediately unable to access the system. You can unblock them later if needed.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary modern-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-warning modern-btn" onclick="confirmBlock()">
                    <i class="fas fa-ban me-2"></i>Block User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Unblock Confirmation Modal -->
<div class="modal fade" id="unblockModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-unlock text-white"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0 fw-bold">Unblock User</h5>
                        <small class="opacity-75">Restore user access</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-3">
                    <div class="bg-success bg-opacity-10 rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-check text-success fa-2x"></i>
                    </div>
                    <h6 class="fw-bold mb-2">Unblock User Account</h6>
                    <p class="text-muted mb-0">
                        Are you sure you want to unblock <strong id="unblockUserName" class="text-dark"></strong>?
                    </p>
                </div>
                <div class="alert alert-success border-0 bg-success bg-opacity-10" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <small class="mb-0">
                            The user will regain full access to the system immediately.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary modern-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-success modern-btn" onclick="confirmUnblock()">
                    <i class="fas fa-unlock me-2"></i>Unblock User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Suspend Confirmation Modal -->
<div class="modal fade" id="suspendModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark border-0">
                <div class="d-flex align-items-center">
                    <div class="bg-dark bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-pause text-dark"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0 fw-bold">Suspend User</h5>
                        <small class="opacity-75">Temporarily restrict access</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-3">
                    <div class="bg-warning bg-opacity-10 rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-clock text-warning fa-2x"></i>
                    </div>
                    <h6 class="fw-bold mb-2">Suspend User Account</h6>
                    <p class="text-muted mb-3">
                        Are you sure you want to suspend <strong id="suspendUserName" class="text-dark"></strong>?
                    </p>
                </div>
                <div class="mb-3">
                    <label for="suspendReason" class="form-label fw-medium">Reason for suspension:</label>
                    <textarea class="form-control" id="suspendReason" rows="3" placeholder="Enter the reason for suspending this user..."></textarea>
                </div>
                <div class="alert alert-warning border-0 bg-warning bg-opacity-10" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        <small class="mb-0">
                            The user will be temporarily unable to access the system. This is a reversible action.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary modern-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-warning modern-btn" onclick="confirmSuspend()">
                    <i class="fas fa-pause me-2"></i>Suspend User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <div class="d-flex align-items-center">
                    <div class="bg-light bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-trash fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0">Delete User Permanently</h5>
                        <small class="opacity-75">This action cannot be undone</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-danger border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-lg me-3"></i>
                        <div>
                            <strong>Warning:</strong> You are about to permanently delete user <strong><span id="deleteUserName"></span></strong>.
                            This action cannot be undone and will remove all associated data.
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="deleteUserData" checked>
                        <label class="form-check-label" for="deleteUserData">
                            Also delete associated data (accounts, transactions)
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            I understand this action is permanent and cannot be undone
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary modern-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger modern-btn" onclick="confirmDelete()">
                    <i class="fas fa-trash me-2"></i>Delete Permanently
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = null;
let currentUserName = null;

// Helper function to get anti-forgery token
function getAntiForgeryToken() {
    // Read the token value from the hidden input rendered by @Html.AntiForgeryToken()
    const formToken = document.querySelector('input[name="__RequestVerificationToken"]');
    return formToken?.value || '';
}

// Show block modal function
function showBlockModal(userId, userName) {
    console.log('🔨 Block modal triggered for user:', userId, userName);
    currentUserId = userId;
    currentUserName = userName;
    document.getElementById('blockUserName').textContent = userName;
    document.getElementById('blockReason').value = '';
    
    const blockModal = new bootstrap.Modal(document.getElementById('blockModal'));
    blockModal.show();
}

// Show suspend modal function
function showSuspendModal(userId, userName) {
    console.log('⏸️ Suspend modal triggered for user:', userId, userName);
    currentUserId = userId;
    currentUserName = userName;
    document.getElementById('suspendUserName').textContent = userName;
    document.getElementById('suspendReason').value = '';
    
    const suspendModal = new bootstrap.Modal(document.getElementById('suspendModal'));
    suspendModal.show();
}

// Show delete modal function
function showDeleteModal(userId, userName) {
    console.log('🗑️ Delete modal triggered for user:', userId, userName);
    currentUserId = userId;
    currentUserName = userName;
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteUserData').checked = true;
    document.getElementById('confirmDelete').checked = false;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

// Show unblock modal function
function showUnblockModal(userId, userName) {
    console.log('🔓 Unblock modal triggered for user:', userId, userName);
    currentUserId = userId;
    currentUserName = userName;
    const nameSpan = document.getElementById('unblockUserName');
    if (nameSpan) nameSpan.textContent = userName;
    const modal = new bootstrap.Modal(document.getElementById('unblockModal'));
    modal.show();
}

// Unblock user function - calls the enhanced version with real-time updates
async function unblockUser(userId, userName) {
    console.log('🔓 Unblock user triggered for user:', userId, userName);
    if (!confirm(`Are you sure you want to unblock ${userName}?`)) {
        return;
    }
    
    // Call the enhanced unblock function with loader
    await unblockUserWithLoader(userId);
}

// Unsuspend user function - calls the enhanced version with real-time updates  
async function unsuspendUser(userId, userName) {
    console.log('▶️ Unsuspend user triggered for user:', userId, userName);
    if (!confirm(`Are you sure you want to lift the suspension for ${userName}?`)) {
        return;
    }
    
    // Call unblock function since unsuspending is handled the same way
    await unblockUserWithLoader(userId);
}

// Block function is now handled by showBlockModal above

// Suspend function is now handled by showSuspendModal above

// Confirm block action
async function confirmBlock() {
    const reason = document.getElementById('blockReason').value.trim();
    
    if (!reason) {
        alert('Please provide a reason for blocking this user.');
        return;
    }
    
    return await blockUserWithLoader(currentUserId, reason);
}

// Confirm unblock action
async function confirmUnblock() {
    return await unblockUserWithLoader(currentUserId);
}

// Confirm suspend action
async function confirmSuspend() {
    const reason = document.getElementById('suspendReason').value.trim();
    
    if (!reason) {
        alert('Please provide a reason for suspending this user.');
        return;
    }
    
    return await suspendUserWithLoader(currentUserId, reason);
}

// Professional Loader integration
const ProfessionalLoader = {
    show(message = 'Loading...', delay = 0, idPrefix = '') {
        const loaderId = `${idPrefix}-loader`;
        const loaderElement = document.createElement('div');
        loaderElement.id = loaderId;
        loaderElement.className = 'professional-loader';
        loaderElement.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loader-message">${message}</div>
        `;
        
        document.body.appendChild(loaderElement);
        
        // Optional: Add a backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'loader-backdrop';
        document.body.appendChild(backdrop);
        
        // Hide loader after delay
        const timer = setTimeout(() => {
            this.hide(loaderId, backdrop);
        }, delay);
        
        return {
            loaderId,
            cancel: () => clearTimeout(timer),
            hide: () => {
                clearTimeout(timer);
                this.hide(loaderId, backdrop);
            }
        };
    },
    showWithDelay(message = 'Loading...', delay = 500, idPrefix = '') {
        return this.show(message, delay, idPrefix);
    },
    hide(loaderId, backdrop) {
        const loaderElement = document.getElementById(loaderId);
        if (loaderElement) {
            loaderElement.remove();
        }
        if (backdrop) {
            backdrop.remove();
        }
    }
};

// Enhanced user action functions with loader integration
// Enhanced User Table Update Function
function updateUserInTable(userData) {
    console.log('🔄 Updating user in table:', userData);
    
    if (!userData || !userData.id) {
        console.warn('❌ Invalid user data provided for table update');
        return;
    }

    // Find the table row for this user
    const userRow = document.querySelector(`tr[data-user-id="${userData.id}"]`);
    if (!userRow) {
        console.warn(`❌ User row not found for ID: ${userData.id}`);
        console.log('Available user rows:', document.querySelectorAll('tr[data-user-id]'));
        return;
    }

    console.log('✅ Found user row for ID:', userData.id);

    try {
        const cells = userRow.querySelectorAll('td');
        
        // Update Status Column (index 8 - Status)
        const statusCell = cells[8];
        if (statusCell && userData.hasOwnProperty('isBlocked')) {
            let statusHtml = '';
            if (userData.isBlocked) {
                statusHtml = `
                    <span class="badge bg-danger">
                        <i class="fas fa-ban me-1"></i>Blocked
                    </span>`;
                if (userData.blockReason) {
                    const truncatedReason = userData.blockReason.length > 20 
                        ? userData.blockReason.substring(0, 20) + "..." 
                        : userData.blockReason;
                    statusHtml += `
                        <div>
                            <small class="text-muted" style="font-size: 0.7rem;" title="${userData.blockReason}">
                                ${truncatedReason}
                            </small>
                        </div>`;
                }
            } else if (userData.status && userData.status.toLowerCase() === 'suspended') {
                statusHtml = `
                    <span class="badge bg-warning">
                        <i class="fas fa-pause me-1"></i>Suspended
                    </span>`;
                if (userData.blockReason) {
                    const truncatedReason = userData.blockReason.length > 20 
                        ? userData.blockReason.substring(0, 20) + "..." 
                        : userData.blockReason;
                    statusHtml += `
                        <div>
                            <small class="text-muted" style="font-size: 0.7rem;" title="${userData.blockReason}">
                                ${truncatedReason}
                            </small>
                        </div>`;
                }
            } else {
                statusHtml = `
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>Active
                    </span>`;
            }
            statusCell.innerHTML = statusHtml;
            console.log('✅ Updated status cell');
        }

        // Update Actions Column (index 9 - Actions)
        const actionsCell = cells[9];
        if (actionsCell) {
            let actionsHtml = `
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="User Actions">
                        <i class="fas fa-cog"></i> Actions
                    </button>
                    <ul class="dropdown-menu">`;
            
            if (userData.status?.toLowerCase() === 'active' && !userData.isBlocked) {
                actionsHtml += `
                    <li><a class="dropdown-item" href="#" onclick="showBlockModal(${userData.id}, '${userData.fullName}')"><i class="fas fa-ban me-2 text-warning"></i>Block User</a></li>
                    <li><a class="dropdown-item" href="#" onclick="showSuspendModal(${userData.id}, '${userData.fullName}')"><i class="fas fa-clock me-2 text-orange"></i>Suspend User</a></li>`;
            } else if (userData.isBlocked) {
                actionsHtml += `
                    <li><a class="dropdown-item" href="#" onclick="showUnblockModal(${userData.id}, '${userData.fullName}')"><i class="fas fa-check me-2 text-success"></i>Unblock User</a></li>`;
            } else if (userData.status?.toLowerCase() === 'suspended') {
                actionsHtml += `
                    <li><a class="dropdown-item" href="#" onclick="unsuspendUser(${userData.id}, '${userData.fullName}')"><i class="fas fa-unlock me-2 text-info"></i>Unsuspend User</a></li>`;
            }
            
            actionsHtml += `
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteModal(${userData.id}, '${userData.fullName}')"><i class="fas fa-trash me-2"></i>Delete User</a></li>
                    </ul>
                </div>`;
            
            actionsCell.innerHTML = actionsHtml;
            
            // IMPORTANT: Re-initialize Bootstrap dropdown for the new HTML
            const newDropdownButton = actionsCell.querySelector('.dropdown-toggle');
            if (newDropdownButton && typeof bootstrap !== 'undefined') {
                try {
                    // Initialize Bootstrap dropdown
                    new bootstrap.Dropdown(newDropdownButton);
                    console.log('✅ Initialized Bootstrap dropdown for updated actions');
                } catch (dropdownError) {
                    console.warn('⚠️ Failed to initialize Bootstrap dropdown:', dropdownError);
                }
            }
            
            console.log('✅ Updated actions cell');
        }

        // Add visual feedback to show the row was updated
        userRow.style.transition = 'all 0.3s ease';
        userRow.style.backgroundColor = '#d4edda'; // Light green
        userRow.style.transform = 'scale(1.005)';
        
        // Add a "Updated!" badge temporarily
        const nameCell = userRow.querySelector('td:nth-child(2)');
        if (nameCell) {
            const existingBadge = nameCell.querySelector('.update-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            const updateBadge = document.createElement('span');
            updateBadge.className = 'badge bg-success ms-2 update-badge animate__animated animate__pulse';
            updateBadge.innerHTML = '<i class="fas fa-check"></i> Updated!';
            nameCell.appendChild(updateBadge);
            
            // Reset visual feedback after animation
            setTimeout(() => {
                userRow.style.backgroundColor = '';
                userRow.style.transform = '';
                if (updateBadge && updateBadge.parentElement) {
                    updateBadge.remove();
                }
            }, 3000);
        }

        console.log(`🎉 Successfully updated user ${userData.id} in table`);
        
        // Show a brief success notification
        if (typeof Modal !== 'undefined' && Modal.showSuccess) {
            Modal.showSuccess(
                'Table Updated!',
                `User "${userData.fullName}" status has been updated in the table. Changes are now visible immediately!`,
                null,
                2000 // Auto-close after 2 seconds
            );
        }
        
    } catch (error) {
        console.error('❌ Error updating user in table:', error);
        
        if (typeof Modal !== 'undefined' && Modal.showError) {
            Modal.showError(
                'Update Display Error',
                'The user action was completed successfully, but there was an issue updating the table display. The page will refresh to show the changes.'
            );
        }
        
        // Fallback: refresh page after a delay if table update fails
        setTimeout(() => {
            console.log('Refreshing page due to table update error...');
            window.location.reload();
        }, 2000);
    }
}

// Enhanced Block User Function with Real-time Updates
async function blockUserWithLoader(userId, reason) {
    // Show loading modal
    let loadingModal = null;
    if (typeof Modal !== 'undefined' && Modal.showLoading) {
        loadingModal = Modal.showLoading('Blocking user...', 'Please wait while we process this action.');
    } else {
        console.log('Blocking user...');
    }
    
    try {
        const response = await fetch(`?handler=BlockUser&userId=${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'RequestVerificationToken': getAntiForgeryToken()
            },
            body: JSON.stringify({ Reason: reason })
        });
        
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Close block modal
                const blockModal = bootstrap.Modal.getInstance(document.getElementById('blockModal'));
                if (blockModal) {
                    blockModal.hide();
                }
                
                // Update the UI immediately with the returned data
                if (result.data) {
                    updateUserInTable(result.data);
                }
                
                // Show success modal
                if (typeof Modal !== 'undefined') {
                    Modal.showSuccess(
                        'User Blocked Successfully!',
                        `User has been blocked and their status is now updated in the table!`
                    );
                }
            } else {
                if (typeof Modal !== 'undefined') {
                    Modal.showError(
                        'Block Failed',
                        result.message || 'Failed to block user. Please try again.'
                    );
                }
            }
        } else {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            if (typeof Modal !== 'undefined') {
                Modal.showError(
                    'Server Error',
                    `Failed to block user. Server error: ${response.status}. Please check the console for details.`
                );
            }
        }
    } catch (error) {
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        console.error('Block error:', error);
        if (typeof Modal !== 'undefined') {
            Modal.showError(
                'Network Error',
                'A network error occurred while blocking the user. Please check your connection and try again.'
            );
        }
        
        // Fallback: refresh after error
        (async () => {
            try {
                await fetch(`/Users?handler=BlockUser&userId=${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({ Reason: reason })
                });
                console.log('Fallback block request completed');
                window.location.reload();
            } catch (fallbackError) {
                console.error('Fallback request failed:', fallbackError);
            }
        })();
    }
}

// Enhanced Unblock User Function with Real-time Updates
async function unblockUserWithLoader(userId) {
    // Show loading modal
    let loadingModal = null;
    if (typeof Modal !== 'undefined' && Modal.showLoading) {
        loadingModal = Modal.showLoading('Unblocking user...', 'Please wait while we process this action.');
    } else {
        console.log('Unblocking user...');
    }
    
    try {
        const response = await fetch(`?handler=UnblockUser&userId=${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'RequestVerificationToken': getAntiForgeryToken()
            }
        });
        
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Close unblock modal if open
                const unblockModal = bootstrap.Modal.getInstance(document.getElementById('unblockModal'));
                if (unblockModal) {
                    unblockModal.hide();
                }
                // Update the UI immediately with the returned data
                if (result.data) {
                    updateUserInTable(result.data);
                }
                
                // Show success modal
                if (typeof Modal !== 'undefined') {
                    Modal.showSuccess(
                        'User Unblocked Successfully!',
                        `User has been unblocked and their status is now updated in the table!`
                    );
                }
            } else {
                if (typeof Modal !== 'undefined') {
                    Modal.showError(
                        'Unblock Failed',
                        result.message || 'Failed to unblock user. Please try again.'
                    );
                }
            }
        } else {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            if (typeof Modal !== 'undefined') {
                Modal.showError(
                    'Server Error',
                    `Failed to unblock user. Server error: ${response.status}. Please check the console for details.`
                );
            }
        }
    } catch (error) {
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        console.error('Unblock error:', error);
        if (typeof Modal !== 'undefined') {
            Modal.showError(
                'Network Error',
                'A network error occurred while unblocking the user. Please check your connection and try again.'
            );
        }
    }
}

// Enhanced Suspend User Function with Real-time Updates
async function suspendUserWithLoader(userId, reason) {
    // Show loading modal
    let loadingModal = null;
    if (typeof Modal !== 'undefined' && Modal.showLoading) {
        loadingModal = Modal.showLoading('Suspending user...', 'Please wait while we process this action.');
    } else {
        console.log('Suspending user...');
    }
    
    try {
        const response = await fetch(`?handler=SuspendUser&userId=${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'RequestVerificationToken': getAntiForgeryToken()
            },
            body: JSON.stringify({ Reason: reason })
        });
        
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Close suspend modal
                const suspendModal = bootstrap.Modal.getInstance(document.getElementById('suspendModal'));
                if (suspendModal) {
                    suspendModal.hide();
                }
                
                // Update the UI immediately with the returned data
                if (result.data) {
                    updateUserInTable(result.data);
                }
                
                // Show success modal
                if (typeof Modal !== 'undefined') {
                    Modal.showSuccess(
                        'User Suspended Successfully!',
                        `User has been suspended and their status is now updated in the table!`
                    );
                }
            } else {
                if (typeof Modal !== 'undefined') {
                    Modal.showError(
                        'Suspend Failed',
                        result.message || 'Failed to suspend user. Please try again.'
                    );
                }
            }
        } else {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            if (typeof Modal !== 'undefined') {
                Modal.showError(
                    'Server Error',
                    `Failed to suspend user. Server error: ${response.status}. Please check the console for details.`
                );
            }
        }
    } catch (error) {
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        console.error('Suspend error:', error);
        if (typeof Modal !== 'undefined') {
            Modal.showError(
                'Network Error',
                'A network error occurred while suspending the user. Please check your connection and try again.'
            );
        }
    }
}

// Initialize scroll functionality for the users table
initializeScrollFunctionality();

// Scroll functionality
function initializeScrollFunctionality() {
    const tableContainer = document.getElementById('users-table-container');
    const scrollToTopBtn = document.getElementById('scrollToTop');
    
    if (tableContainer && scrollToTopBtn) {
        // Show/hide scroll to top button based on scroll position
        tableContainer.addEventListener('scroll', function() {
            if (this.scrollTop > 200) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        });
        
        // Smooth scroll behavior
        tableContainer.style.scrollBehavior = 'smooth';
    }
}

function scrollToTop() {
    const tableContainer = document.getElementById('users-table-container');
    if (tableContainer) {
        tableContainer.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
}

// Enhanced scroll to specific user
function scrollToUser(userId) {
    const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
    if (userRow) {
        userRow.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
        
        // Highlight the row briefly
        userRow.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
        setTimeout(() => {
            userRow.style.backgroundColor = '';
        }, 2000);
    }
}

// Initialize Bootstrap dropdowns for all action buttons
function initializeAllDropdowns() {
    console.log('🔧 Re-initializing dropdowns after page load...');
    
    // Wait for DOM and use broader selectors
    setTimeout(() => {
        // Try multiple selectors to catch all dropdown buttons
        const selectors = [
            '.dropdown-toggle',
            '[data-bs-toggle="dropdown"]',
            '#usersTableBody .dropdown-toggle',
            'button.dropdown-toggle'
        ];
        
        let allButtons = [];
        selectors.forEach(selector => {
            const buttons = document.querySelectorAll(selector);
            buttons.forEach(btn => {
                if (!allButtons.includes(btn)) {
                    allButtons.push(btn);
                }
            });
        });
        
        console.log(`🔧 Found ${allButtons.length} dropdown buttons to initialize`);
        
        allButtons.forEach((button, index) => {
            try {
                // Skip if already initialized
                if (button.hasAttribute('data-dropdown-initialized')) {
                    console.log(`⏭️ Skipping already initialized dropdown ${index + 1}`);
                    return;
                }
                
                if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
                    // Dispose existing instance
                    let existing = bootstrap.Dropdown.getInstance(button);
                    if (existing) {
                        existing.dispose();
                    }
                    
                    new bootstrap.Dropdown(button);
                    button.setAttribute('data-dropdown-initialized', 'true');
                    console.log(`✅ Initialized dropdown ${index + 1}/${allButtons.length}`, button);
                } else {
                    console.warn('⚠️ Bootstrap not available');
                }
            } catch (error) {
                console.warn('⚠️ Failed to initialize dropdown:', error, button);
            }
        });
        
        // Force re-scan for any missed buttons
        const tableBody = document.getElementById('usersTableBody');
        if (tableBody) {
            const tableDropdowns = tableBody.querySelectorAll('.dropdown-toggle');
            console.log(`📊 Table has ${tableDropdowns.length} dropdown buttons`);
        }
        
    }, 200); // Longer delay to ensure everything is loaded
}

// Page load integration
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap dropdowns for all action buttons
    console.log('🔧 Initializing Bootstrap dropdowns on page load...');
    initializeAllDropdowns();
    
    // Show loader on initial page load if we have many users
    const userCount = @Model.TotalCount;
    
    // Show loader for initial large data loads
    if (userCount > 50) {
        const initialLoader = ProfessionalLoader.showWithDelay('Loading user data...', 100, 'users');
        
        // Hide loader once the page is fully loaded
        window.addEventListener('load', function() {
            setTimeout(() => {
                initialLoader.hide();
            }, 500); // Small delay to ensure smooth transition
        });
    }
    
    // Add loader to sort links
    document.querySelectorAll('.sort-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.getAttribute('href');
            if (url) {
                handleNavigationWithLoader(url, 'Sorting data...');
            }
        });
    });
    
    // Add loader to filter form submission
    const filterForm = document.querySelector('#filterPanel form');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleFormSubmissionWithLoader(this, 'Applying filters...');
        });
    }
    
    // Debug helper function for users table
    window.debugUserUpdate = function(userId) {
        console.log('🔍 Debugging User Update for ID:', userId);
        
        // Check if row exists
        const row = document.querySelector(`tr[data-user-id="${userId}"]`);
        console.log('Row found:', row);
        
        // Check table structure
        const allRows = document.querySelectorAll('tr[data-user-id]');
        console.log('All user rows:', allRows.length);
        
        // Check cells
        if (row) {
            const statusCell = row.querySelectorAll('td')[8]; // Status column
            const actionsCell = row.querySelectorAll('td')[9]; // Actions column
            console.log('Status cell:', statusCell);
            console.log('Actions cell:', actionsCell);
        }
        
        return { row, statusCell: row?.querySelectorAll('td')[8], actionsCell: row?.querySelectorAll('td')[9] };
    };

    // Manual dropdown fix function (can be called from console if needed)
    window.fixAllDropdowns = function() {
        console.log('🛠️ Manual dropdown fix initiated...');
        
        // Remove all existing dropdown initializations
        document.querySelectorAll('.dropdown-toggle, [data-bs-toggle="dropdown"]').forEach(btn => {
            btn.removeAttribute('data-dropdown-initialized');
            try {
                let existing = bootstrap.Dropdown.getInstance(btn);
                if (existing) {
                    existing.dispose();
                }
            } catch (e) { /* ignore */ }
        });
        
        // Re-initialize all dropdowns
        setTimeout(() => {
            initializeAllDropdowns();
        }, 100);
        
        console.log('✅ All dropdowns have been re-initialized');
        return 'Dropdown fix complete!';
    };

    // Debug function to inspect dropdowns
    window.debugDropdowns = function() {
        console.log('🔍 Debugging dropdown state...');
        console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
        
        const tableBody = document.getElementById('usersTableBody');
        console.log('Table body found:', !!tableBody);
        
        const allDropdowns = document.querySelectorAll('.dropdown-toggle');
        console.log(`Total .dropdown-toggle elements: ${allDropdowns.length}`);
        
        const bsToggleDropdowns = document.querySelectorAll('[data-bs-toggle="dropdown"]');
        console.log(`Total [data-bs-toggle="dropdown"] elements: ${bsToggleDropdowns.length}`);
        
        allDropdowns.forEach((btn, i) => {
            const instance = bootstrap.Dropdown.getInstance(btn);
            console.log(`Dropdown ${i + 1}:`, {
                hasInstance: !!instance,
                visible: btn.offsetParent !== null,
                initialized: btn.hasAttribute('data-dropdown-initialized'),
                classes: btn.className
            });
        });
        
        return `Found ${allDropdowns.length} dropdowns`;
    };

    // Initialize scroll functionality for the users table
    initializeScrollFunctionality();
    
    // Re-initialize dropdowns periodically to catch any missed ones
    setTimeout(() => {
        console.log('🔧 Re-initializing dropdowns after page load...');
        initializeAllDropdowns();
    }, 1000);
    
    // Also re-initialize when the page becomes visible (in case of tab switching)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            setTimeout(() => {
                initializeAllDropdowns();
            }, 200);
        }
    });
    
    // Auto-collapse filter panel if no filters are active
    const filterPanel = document.getElementById('filterPanel');
    const hasActiveFilters = @Html.Raw(Json.Serialize(!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter) || !string.IsNullOrEmpty(Model.RelationFilter) || Model.CreatedFromDate.HasValue || Model.CreatedToDate.HasValue));
    
    if (!hasActiveFilters) {
        const collapseElement = new bootstrap.Collapse(filterPanel, {
            toggle: false
        });
    }
    
    // Hide loader on page unload/navigation
    window.addEventListener('beforeunload', function() {
        hideLoader();
    });
});

// Handle browser back/forward navigation
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        hideLoader();
    }
});

// Service status checking function
async function checkServiceStatus() {
    const statusBtn = document.querySelector('[onclick="checkServiceStatus()"]');
    const originalText = statusBtn.innerHTML;
    
    try {
        statusBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
        statusBtn.disabled = true;
        
        // Try to ping the backend service
        const response = await fetch('https://nanacaring-backend.onrender.com/api/health', {
            method: 'GET',
            mode: 'no-cors', // To avoid CORS issues
            cache: 'no-cache'
        });
        
        // Since we're using no-cors, we can't read the response
        // But if it doesn't throw an error, the service is likely responding
        setTimeout(() => {
            alert('Service appears to be responding. Please try refreshing the page.');
            statusBtn.innerHTML = originalText;
            statusBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.log('Service check error (expected with no-cors):', error);
        setTimeout(() => {
            alert('Service check completed. The backend may still be starting up. Please wait a moment and try refreshing.');
            statusBtn.innerHTML = originalText;
            statusBtn.disabled = false;
        }, 2000);
    }
}

// Auto-retry mechanism
let autoRetryCount = 0;
const maxAutoRetries = 3;

function startAutoRetry() {
    if (autoRetryCount < maxAutoRetries && document.querySelector('.alert-warning')) {
        autoRetryCount++;
        console.log(`Auto-retry attempt ${autoRetryCount}/${maxAutoRetries} in 30 seconds...`);
        
        setTimeout(() => {
            if (document.querySelector('.alert-warning')) {
                console.log(`Executing auto-retry ${autoRetryCount}...`);
                window.location.reload();
            }
        }, 30000); // Retry after 30 seconds
    }
}

// Start auto-retry if there's an error message
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.alert-warning')) {
        startAutoRetry();
    }
});

// Enhanced Confirm Delete Function with Real-time UI Updates
async function confirmDelete() {
    const deleteData = document.getElementById('deleteUserData').checked;
    const confirmDelete = document.getElementById('confirmDelete').checked;
    
    if (!confirmDelete) {
        if (typeof Modal !== 'undefined') {
            Modal.showError(
                'Confirmation Required',
                'Please confirm that you understand this action is permanent by checking the confirmation box.'
            );
        } else {
            alert('Please confirm that you understand this action is permanent.');
        }
        return;
    }

    // Show loading modal
    let loadingModal = null;
    if (typeof Modal !== 'undefined' && Modal.showLoading) {
        loadingModal = Modal.showLoading('Deleting user...', 'Please wait while we permanently remove this user.');
    } else {
        console.log('Deleting user...');
    }

    try {
        const response = await fetch(`?handler=Delete&id=${currentUserId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'RequestVerificationToken': getAntiForgeryToken()
            },
            body: JSON.stringify({ 
                ConfirmDelete: true,
                DeleteData: deleteData
            })
        });

        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }

        if (response.ok) {
            const result = await response.json();

            if (result.success) {
                // Close delete modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Remove the user row from table immediately
                const userRow = document.querySelector(`tr[data-user-id="${currentUserId}"]`);
                if (userRow) {
                    // Add deletion animation
                    userRow.style.transition = 'all 0.5s ease';
                    userRow.style.backgroundColor = '#f8d7da'; // Light red
                    userRow.style.opacity = '0.5';
                    userRow.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        userRow.style.height = '0';
                        userRow.style.padding = '0';
                        userRow.style.margin = '0';
                        userRow.style.border = 'none';
                        
                        setTimeout(() => {
                            userRow.remove();
                            console.log(`✅ Removed user row ${currentUserId} from table`);
                        }, 300);
                    }, 300);
                }
                
                // Show success modal
                if (typeof Modal !== 'undefined') {
                    Modal.showSuccess(
                        'User Deleted Successfully!',
                        `"${currentUserName}" has been permanently deleted and removed from the system.`
                    );
                } else {
                    showAlert('success', `${currentUserName} has been deleted successfully!`);
                }
                
            } else {
                if (typeof Modal !== 'undefined') {
                    Modal.showError(
                        'Delete Failed',
                        result.message || 'Failed to delete user. Please try again.'
                    );
                } else {
                    showAlert('danger', result.message || 'Failed to delete user');
                }
            }
        } else {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            if (typeof Modal !== 'undefined') {
                Modal.showError(
                    'Server Error',
                    `Failed to delete user. Server error: ${response.status}. Please check the console for details.`
                );
            } else {
                showAlert('danger', 'Server error occurred while deleting user');
            }
        }
    } catch (error) {
        if (typeof Modal !== 'undefined' && Modal.hide) {
            Modal.hide();
        }
        console.error('Delete user error:', error);
        if (typeof Modal !== 'undefined') {
            Modal.showError(
                'Network Error',
                'A network error occurred while deleting the user. Please check your connection and try again.'
            );
        } else {
            showAlert('danger', 'An error occurred while deleting the user');
        }
        
        // Fallback: try again with basic fetch
        (async () => {
            try {
                await fetch(`/Users?handler=Delete&id=${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: new FormData()
                });
                console.log('Fallback delete request completed');
                window.location.reload();
            } catch (fallbackError) {
                console.error('Fallback delete failed:', fallbackError);
            }
        })();
    }
}

// Utility function to show alerts
function showAlert(type, message) {
    const alertContainer = document.createElement('div');
    alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    alertContainer.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertContainer);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertContainer.parentNode) {
            alertContainer.remove();
        }
    }, 5000);
}
</script>
